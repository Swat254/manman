<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Swat Game - Win Real Money</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #1a237e;
            --secondary: #00bcd4;
            --accent: #ff5722;
            --success: #4caf50;
            --danger: #f44336;
            --warning: #ff9800;
            --dark: #0d1440;
            --light: #f5f5f5;
            --text: #333333;
            --nav-bg: rgba(13, 20, 64, 0.95);
        }
        
        body {
            background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            position: relative;
            min-height: 90vh;
        }
        
        header {
            padding: 20px;
            text-align: center;
            background: rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .auth-section {
            position: absolute;
            top: 20px;
            right: 20px;
        }
        
        .auth-btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .auth-btn:hover {
            background: #ff7043;
            transform: translateY(-2px);
        }
        
        h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--secondary);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .app-version {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: var(--secondary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            border: 2px solid white;
        }
        
        .user-details {
            text-align: left;
        }
        
        .user-name {
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .user-balance {
            font-size: 1.2rem;
            color: var(--secondary);
            font-weight: bold;
        }
        
        .notification-bell {
            position: absolute;
            top: 20px;
            left: 20px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary);
            z-index: 5;
        }
        
        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .nav-tabs {
            display: flex;
            background: var(--nav-bg);
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.3);
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: white;
        }
        
        .nav-tab i {
            font-size: 1.2rem;
        }
        
        .nav-tab.active {
            background: rgba(255, 255, 255, 0.15);
            border-top: 3px solid var(--secondary);
            color: var(--secondary);
        }
        
        .tab-content {
            display: none;
            padding: 20px;
            min-height: 500px;
            overflow-y: auto;
            max-height: calc(90vh - 180px);
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            color: var(--text);
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: var(--accent);
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn-secondary {
            background: var(--secondary);
        }
        
        .btn-success {
            background: var(--success);
        }
        
        .btn-danger {
            background: var(--danger);
        }
        
        .btn-warning {
            background: var(--warning);
        }
        
        .wallet-balance {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .balance-amount {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 10px 0;
            color: var(--secondary);
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .action-buttons .btn {
            flex: 1;
        }
        
        .game-container {
            text-align: center;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
        }
        
        .game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin: 20px 0;
        }
        
        .game-cell {
            aspect-ratio: 1;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .game-cell.flipped {
            background: rgba(255, 255, 255, 0.4);
            transform: rotateY(180deg);
        }
        
        .game-cell.matched {
            background: rgba(76, 175, 80, 0.6);
            cursor: default;
        }
        
        .bet-section {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .bet-options {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        
        .bet-option {
            flex: 1;
            min-width: 80px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .bet-option.active {
            background: var(--accent);
            transform: scale(1.05);
        }
        
        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            margin: 10px 0;
            color: var(--secondary);
        }
        
        .reward-info {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .reward-list {
            list-style: none;
            margin-top: 10px;
        }
        
        .reward-list li {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .transaction-history {
            margin-top: 20px;
        }
        
        .transaction-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .transaction-amount.positive {
            color: var(--success);
        }
        
        .transaction-amount.negative {
            color: var(--danger);
        }
        
        .profile-section {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-content {
            display: none;
            margin-top: 15px;
        }
        
        .section-content.active {
            display: block;
        }
        
        .profile-info {
            margin-bottom: 15px;
        }
        
        .faq-item {
            margin-bottom: 15px;
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            cursor: pointer;
        }
        
        .faq-question {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .faq-answer {
            display: none;
        }
        
        .faq-answer.active {
            display: block;
        }
        
        .support-form textarea {
            width: 100%;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
            min-height: 120px;
            margin-bottom: 15px;
            color: var(--text);
        }
        
        .message {
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .message.success {
            background: rgba(76, 175, 80, 0.3);
            border-left: 4px solid var(--success);
        }
        
        .message.error {
            background: rgba(244, 67, 54, 0.3);
            border-left: 4px solid var(--danger);
        }
        
        .message.info {
            background: rgba(0, 188, 212, 0.3);
            border-left: 4px solid var(--secondary);
        }
        
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
        
        .auth-modal.active {
            display: flex;
        }
        
        .auth-form {
            background: linear-gradient(135deg, var(--primary) 0%, var(--dark) 100%);
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
        }
        
        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }
        
        .auth-tab.active {
            border-bottom: 2px solid var(--secondary);
            color: var(--secondary);
        }
        
        .notification-panel {
            display: none;
            position: absolute;
            top: 60px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            width: 300px;
            border-radius: 10px;
            padding: 15px;
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .notification-panel.active {
            display: block;
        }
        
        .notification-item {
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .notification-item:last-child {
            border-bottom: none;
        }
        
        .referral-section {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .referral-code {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            text-align: center;
            font-size: 1.2rem;
            letter-spacing: 2px;
        }
        
        .referral-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
        }
        
        .stat-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            flex: 1;
            margin: 0 5px;
        }
        
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--secondary);
        }
        
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .stats-section {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .achievement-badge {
            display: inline-block;
            background: var(--warning);
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            margin: 2px;
        }
        
        .notification-item.unread {
            background: rgba(0, 188, 212, 0.1);
            border-left: 3px solid var(--secondary);
            padding-left: 12px;
        }
        
        @media (min-width: 768px) {
            .container {
                max-width: 800px;
            }
            
            .game-board {
                gap: 12px;
            }
            
            .game-cell {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="notification-bell">
                <i class="fas fa-bell"></i>
                <div class="badge" id="notification-count">0</div>
                <div class="notification-panel" id="notification-panel">
                    <div class="notification-item">Loading notifications...</div>
                </div>
            </div>
            
            <div class="auth-section">
                <button class="auth-btn" id="auth-toggle">Login</button>
            </div>
            
            <h1>SWAT GAME</h1>
            <div class="app-version">Win Real Money - KES</div>
            
            <div class="user-info" id="user-info" style="display: none;">
                <div class="profile-pic" id="profile-pic">JD</div>
                <div class="user-details">
                    <div class="user-name" id="user-name">John Doe</div>
                    <div class="user-balance">KES <span id="balance">0.00</span></div>
                </div>
            </div>
        </header>
        
        <div class="tab-content active" id="dashboard">
            <div class="wallet-balance">
                <div>Your Balance</div>
                <div class="balance-amount">KES <span id="dashboard-balance">0.00</span></div>
                <div>Available to play or withdraw</div>
            </div>
            
            <div class="stats-section">
                <h3>Your Game Stats</h3>
                <div class="stats-grid" id="game-stats">
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Games Played</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0</div>
                        <div class="stat-label">Games Won</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">0.00</div>
                        <div class="stat-label">Total Earnings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">N/A</div>
                        <div class="stat-label">Best Time</div>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-secondary" id="deposit-btn">Deposit</button>
                <button class="btn btn-success" id="play-now-btn">Play Now</button>
                <button class="btn btn-danger" id="withdraw-btn">Withdraw</button>
            </div>
            
            <div class="referral-section">
                <h3>Refer & Earn</h3>
                <p>Share your referral code and earn KES 10 for each friend who signs up!</p>
                <div class="referral-code" id="referral-code">SWAT-XXXXXX</div>
                <button class="btn btn-secondary" id="copy-referral">Copy Referral Code</button>
                
                <div class="referral-stats">
                    <div class="stat-box">
                        <div class="stat-value" id="referral-count">0</div>
                        <div class="stat-label">Referrals</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="referral-earnings">0</div>
                        <div class="stat-label">Earnings (KES)</div>
                    </div>
                </div>
            </div>
            
            <div class="transaction-history">
                <h3>Recent Transactions</h3>
                <div id="transaction-list">
                    <div class="transaction-item">
                        <div>No transactions yet</div>
                        <div class="transaction-amount positive">+KES 0.00</div>
                        <div>Start playing!</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="play">
            <div class="game-container">
                <div class="bet-section">
                    <h3>Place Your Bet</h3>
                    <div class="form-group">
                        <label for="bet-amount">Bet Amount (KES)</label>
                        <input type="number" id="bet-amount" min="10" max="1000" value="100">
                    </div>
                    
                    <div class="form-group">
                        <label>Time Challenge</label>
                        <div class="bet-options">
                            <div class="bet-option" data-time="10" data-multiplier="5">10s (5x)</div>
                            <div class="bet-option active" data-time="20" data-multiplier="2">20s (2x)</div>
                            <div class="bet-option" data-time="30" data-multiplier="1.5">30s (1.5x)</div>
                            <div class="bet-option" data-time="40" data-multiplier="1.25">40s (1.25x)</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-success" id="start-game">Start Game</button>
                </div>
                
                <div class="game-info">
                    <div>Time: <span class="timer" id="game-timer">20</span>s</div>
                    <div>Moves: <span id="moves">0</span></div>
                    <div>Matches: <span id="matches">0</span>/8</div>
                </div>
                
                <div class="game-board" id="game-board">
                    <!-- Game cards will be generated by JavaScript -->
                </div>
                
                <div class="reward-info">
                    <h3>Reward Multipliers</h3>
                    <ul class="reward-list">
                        <li>Complete in 10 seconds: 5x your bet</li>
                        <li>Complete in 20 seconds: 2x your bet</li>
                        <li>Complete in 30 seconds: 1.5x your bet</li>
                        <li>Complete in 40 seconds: 1.25x your bet</li>
                        <li>Fail to complete: Lose your bet</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="wallet">
            <div class="wallet-balance">
                <div>Your Balance</div>
                <div class="balance-amount">KES <span id="wallet-balance">0.00</span></div>
            </div>
            
            <div class="profile-section">
                <div class="section-header">
                    <h3>Deposit Funds</h3>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label for="deposit-amount">Deposit Amount (KES)</label>
                        <input type="number" id="deposit-amount" min="100" value="500">
                        <button class="btn btn-secondary" id="confirm-deposit" style="margin-top: 10px;">Deposit</button>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="section-header">
                    <h3>Withdraw Funds</h3>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label for="withdraw-amount">Withdraw Amount (KES)</label>
                        <input type="number" id="withdraw-amount" min="100" value="200">
                        <button class="btn btn-danger" id="confirm-withdraw" style="margin-top: 10px;">Withdraw</button>
                    </div>
                </div>
            </div>
            
            <div class="transaction-history">
                <h3>Transaction History</h3>
                <div id="wallet-transaction-list">
                    <div class="transaction-item">
                        <div>No transactions yet</div>
                        <div class="transaction-amount positive">+KES 0.00</div>
                        <div>Start playing!</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tab-content" id="account">
            <div class="profile-section">
                <div class="section-header">
                    <h3>Profile Information</h3>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label for="user-name">Full Name</label>
                        <input type="text" id="user-name" placeholder="Enter your full name">
                    </div>
                    <div class="form-group">
                        <label for="user-email">Email</label>
                        <input type="email" id="user-email" placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label for="user-phone">Phone Number</label>
                        <input type="tel" id="user-phone" placeholder="Enter your phone number">
                    </div>
                    <button class="btn btn-success" id="save-profile">Save Profile</button>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="section-header">
                    <h3>Game Statistics</h3>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="section-content">
                    <div class="stats-grid" id="account-game-stats">
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Total Games</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0</div>
                            <div class="stat-label">Wins</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0%</div>
                            <div class="stat-label">Win Rate</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0.00</div>
                            <div class="stat-label">Total Wagered</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0.00</div>
                            <div class="stat-label">Total Earnings</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">0.00</div>
                            <div class="stat-label">Highest Win</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="section-header">
                    <h3>Achievements</h3>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="section-content" id="achievements-list">
                    <p>No achievements yet. Keep playing to earn achievements!</p>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="section-header">
                    <h3>Referral Program</h3>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="section-content">
                    <div class="referral-section">
                        <p>Earn KES 10 for each friend who signs up using your referral code, plus 5% of their withdrawal amounts!</p>
                        <div class="referral-code" id="account-referral-code">SWAT-XXXXXX</div>
                        <button class="btn btn-secondary" id="copy-account-referral">Copy Referral Code</button>
                        
                        <div class="referral-stats">
                            <div class="stat-box">
                                <div class="stat-value" id="account-referral-count">0</div>
                                <div class="stat-label">Referrals</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="account-referral-earnings">0</div>
                                <div class="stat-label">Earnings (KES)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="section-header">
                    <h3>Change Password</h3>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label for="current-password">Current Password</label>
                        <input type="password" id="current-password" placeholder="Enter current password">
                    </div>
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" placeholder="Enter new password">
                    </div>
                    <div class="form-group">
                        <label for="confirm-password">Confirm New Password</label>
                        <input type="password" id="confirm-password" placeholder="Confirm new password">
                    </div>
                    <button class="btn btn-warning" id="change-password">Change Password</button>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="section-header">
                    <h3>Frequently Asked Questions</h3>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="section-content">
                    <div class="faq-item">
                        <div class="faq-question">
                            <span>How do I win money?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            Complete the memory game within your selected time limit to multiply your bet.
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">
                            <span>How does the referral program work?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            Share your referral code with friends. When they sign up, you get KES 10. You also earn 5% of every withdrawal they make!
                        </div>
                    </div>
                    <div class="faq-item">
                        <div class="faq-question">
                            <span>What happens if I don't complete the game in time?</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="faq-answer">
                            You will lose your bet amount if you fail to match all pairs within the time limit.
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="section-header">
                    <h3>Contact Support</h3>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div class="section-content">
                    <div class="form-group">
                        <label for="support-subject">Subject</label>
                        <input type="text" id="support-subject" placeholder="Enter subject">
                    </div>
                    <div class="form-group">
                        <label for="support-message">Message</label>
                        <textarea id="support-message" placeholder="Enter your message"></textarea>
                    </div>
                    <button class="btn btn-secondary" id="send-support">Send Message</button>
                </div>
            </div>
        </div>
        
        <div class="nav-tabs">
            <div class="nav-tab active" data-tab="dashboard">
                <i class="fas fa-home"></i>
                <span>Dashboard</span>
            </div>
            <div class="nav-tab" data-tab="play">
                <i class="fas fa-gamepad"></i>
                <span>Play Game</span>
            </div>
            <div class="nav-tab" data-tab="wallet">
                <i class="fas fa-wallet"></i>
                <span>Wallet</span>
            </div>
            <div class="nav-tab" data-tab="account">
                <i class="fas fa-user"></i>
                <span>Account</span>
            </div>
        </div>
    </div>
    
    <!-- Auth Modal -->
    <div class="auth-modal" id="auth-modal">
        <div class="auth-form">
            <div class="auth-tabs">
                <div class="auth-tab active" data-auth="login">Login</div>
                <div class="auth-tab" data-auth="signup">Sign Up</div>
            </div>
            
            <div id="login-form">
                <div class="form-group">
                    <label for="login-email">Email</label>
                    <input type="email" id="login-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="login-password">Password</label>
                    <input type="password" id="login-password" placeholder="Enter your password">
                </div>
                <div class="form-group">
                    <label for="referral-code-input">Referral Code (Optional)</label>
                    <input type="text" id="referral-code-input" placeholder="Enter referral code if any">
                </div>
                <button class="btn btn-success" id="login-btn">Login</button>
            </div>
            
            <div id="signup-form" style="display: none;">
                <div class="form-group">
                    <label for="signup-name">Full Name</label>
                    <input type="text" id="signup-name" placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label for="signup-email">Email</label>
                    <input type="email" id="signup-email" placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label for="signup-phone">Phone Number</label>
                    <input type="tel" id="signup-phone" placeholder="Enter your phone number">
                </div>
                <div class="form-group">
                    <label for="signup-password">Password</label>
                    <input type="password" id="signup-password" placeholder="Create a password">
                </div>
                <div class="form-group">
                    <label for="signup-confirm-password">Confirm Password</label>
                    <input type="password" id="signup-confirm-password" placeholder="Confirm your password">
                </div>
                <div class="form-group">
                    <label for="signup-referral-code">Referral Code (Optional)</label>
                    <input type="text" id="signup-referral-code" placeholder="Enter referral code if any">
                </div>
                <button class="btn btn-success" id="signup-btn">Sign Up</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://mgrytmqldfndztfhwrpq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1ncnl0bXFsZGZuZHp0Zmh3cnBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNDExODUsImV4cCI6MjA3OTkxNzE4NX0.9yG9wPZjvQwbOhJGswCDjx0OuKOFWokci0TqcndAg5g';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // User data
        let userData = {
            loggedIn: false,
            id: null,
            name: "",
            email: "",
            phone: "",
            balance: 0,
            profilePic: "",
            referralCode: null,
            referredBy: null,
            referralCount: 0,
            referralEarnings: 0,
            gameStats: {},
            achievements: [],
            transactions: [],
            notifications: []
        };
        
        // Game state
        let gameState = {
            cards: [],
            flippedCards: [],
            moves: 0,
            matches: 0,
            lockBoard: false,
            gameActive: false,
            timer: null,
            timeLeft: 20,
            selectedTime: 20,
            selectedMultiplier: 2,
            betAmount: 100,
            cardSymbols: ['ðŸŽ', 'ðŸŒ', 'ðŸ’', 'ðŸ‡', 'ðŸŠ', 'ðŸ“', 'ðŸ‘', 'ðŸ¥']
        };
        
        // DOM elements
        const balanceEl = document.getElementById('balance');
        const dashboardBalanceEl = document.getElementById('dashboard-balance');
        const walletBalanceEl = document.getElementById('wallet-balance');
        const gameBoardEl = document.getElementById('game-board');
        const movesEl = document.getElementById('moves');
        const matchesEl = document.getElementById('matches');
        const gameTimerEl = document.getElementById('game-timer');
        const betAmountEl = document.getElementById('bet-amount');
        const transactionListEl = document.getElementById('transaction-list');
        const walletTransactionListEl = document.getElementById('wallet-transaction-list');
        const userInfoEl = document.getElementById('user-info');
        const profilePicEl = document.getElementById('profile-pic');
        const userNameEl = document.getElementById('user-name');
        const authModalEl = document.getElementById('auth-modal');
        const notificationBellEl = document.querySelector('.notification-bell');
        const notificationPanelEl = document.querySelector('.notification-panel');
        const referralCodeEl = document.getElementById('referral-code');
        const accountReferralCodeEl = document.getElementById('account-referral-code');
        const referralCountEl = document.getElementById('referral-count');
        const accountReferralCountEl = document.getElementById('account-referral-count');
        const referralEarningsEl = document.getElementById('referral-earnings');
        const accountReferralEarningsEl = document.getElementById('account-referral-earnings');
        
        // Initialize the app
        async function initApp() {
            await checkAuthStatus();
            updateBalance();
            renderTransactions();
            setupEventListeners();
        }
        
        // Check authentication status
        async function checkAuthStatus() {
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                // User is logged in, fetch user data
                await fetchUserData(session.user.id);
                updateUIForLoggedInUser();
            } else {
                showAuthModal();
            }
        }
        
        // Fetch user data from Supabase
        async function fetchUserData(userId) {
            try {
                // Fetch user profile
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();
                
                if (error) throw error;
                
                if (profile) {
                    userData.id = profile.id;
                    userData.name = profile.full_name;
                    userData.email = profile.email;
                    userData.phone = profile.phone;
                    userData.balance = parseFloat(profile.balance) || 0;
                    userData.profilePic = profile.profile_pic || profile.full_name.split(' ').map(n => n[0]).join('').toUpperCase();
                    userData.referralCode = profile.referral_code;
                    userData.referredBy = profile.referred_by;
                    userData.referralCount = profile.referral_count || 0;
                    userData.referralEarnings = parseFloat(profile.referral_earnings) || 0;
                    userData.loggedIn = true;
                    
                    // Fetch additional data in parallel
                    await Promise.all([
                        fetchUserTransactions(userId),
                        fetchGameStatistics(userId),
                        fetchUserAchievements(userId),
                        fetchUserNotifications(userId)
                    ]);
                }
            } catch (error) {
                console.error('Error fetching user data:', error);
            }
        }
        
        // Fetch user transactions
        async function fetchUserTransactions(userId) {
            try {
                const { data: transactions, error } = await supabase
                    .from('transactions')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                if (transactions) {
                    userData.transactions = transactions.map(t => ({
                        type: t.type,
                        amount: t.amount,
                        description: t.description,
                        date: formatDate(t.created_at)
                    }));
                }
            } catch (error) {
                console.error('Error fetching transactions:', error);
            }
        }
        
        // Fetch game statistics
        async function fetchGameStatistics(userId) {
            try {
                const { data: stats, error } = await supabase
                    .from('game_statistics')
                    .select('*')
                    .eq('user_id', userId)
                    .single();
                
                if (error && error.code !== 'PGRST116') throw error; // PGRST116 is "not found"
                
                userData.gameStats = stats || {
                    total_games_played: 0,
                    total_games_won: 0,
                    total_wagered: 0,
                    total_earnings: 0,
                    best_time: null,
                    highest_win: 0,
                    favorite_time_challenge: 20
                };
                
                updateGameStatsUI();
            } catch (error) {
                console.error('Error fetching game statistics:', error);
            }
        }
        
        // Fetch user achievements
        async function fetchUserAchievements(userId) {
            try {
                const { data: achievements, error } = await supabase
                    .from('user_achievements')
                    .select('*')
                    .eq('user_id', userId);
                
                if (error) throw error;
                
                userData.achievements = achievements || [];
                updateAchievementsUI();
            } catch (error) {
                console.error('Error fetching achievements:', error);
            }
        }
        
        // Fetch user notifications
        async function fetchUserNotifications(userId) {
            try {
                const { data: notifications, error } = await supabase
                    .from('notifications')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (error) throw error;
                
                userData.notifications = notifications || [];
                updateNotificationsUI();
            } catch (error) {
                console.error('Error fetching notifications:', error);
            }
        }
        
        // Format date for display
        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minutes ago`;
            if (diffHours < 24) return `${diffHours} hours ago`;
            if (diffDays < 7) return `${diffDays} days ago`;
            
            return date.toLocaleDateString();
        }
        
        // Update UI for logged in user
        function updateUIForLoggedInUser() {
            userInfoEl.style.display = 'flex';
            document.getElementById('auth-toggle').textContent = 'Logout';
            updateBalance();
            renderTransactions();
            updateReferralInfo();
            profilePicEl.textContent = userData.profilePic;
            userNameEl.textContent = userData.name;
        }
        
        // Update balance display
        function updateBalance() {
            if (userData.loggedIn) {
                balanceEl.textContent = userData.balance.toFixed(2);
                dashboardBalanceEl.textContent = userData.balance.toFixed(2);
                walletBalanceEl.textContent = userData.balance.toFixed(2);
            }
        }
        
        // Update referral information
        function updateReferralInfo() {
            if (userData.loggedIn) {
                referralCodeEl.textContent = userData.referralCode;
                accountReferralCodeEl.textContent = userData.referralCode;
                referralCountEl.textContent = userData.referralCount;
                accountReferralCountEl.textContent = userData.referralCount;
                referralEarningsEl.textContent = userData.referralEarnings.toFixed(2);
                accountReferralEarningsEl.textContent = userData.referralEarnings.toFixed(2);
            }
        }
        
        // Update game statistics UI
        function updateGameStatsUI() {
            const stats = userData.gameStats;
            const statsGrid = document.getElementById('game-stats');
            const accountStatsGrid = document.getElementById('account-game-stats');
            
            if (statsGrid) {
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_games_played}</div>
                        <div class="stat-label">Games Played</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_games_won}</div>
                        <div class="stat-label">Games Won</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_earnings.toFixed(2)}</div>
                        <div class="stat-label">Total Earnings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.best_time ? stats.best_time + 's' : 'N/A'}</div>
                        <div class="stat-label">Best Time</div>
                    </div>
                `;
            }
            
            if (accountStatsGrid) {
                accountStatsGrid.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_games_played}</div>
                        <div class="stat-label">Total Games</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_games_won}</div>
                        <div class="stat-label">Wins</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_games_played > 0 ? ((stats.total_games_won / stats.total_games_played) * 100).toFixed(1) + '%' : '0%'}</div>
                        <div class="stat-label">Win Rate</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_wagered.toFixed(2)}</div>
                        <div class="stat-label">Total Wagered</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.total_earnings.toFixed(2)}</div>
                        <div class="stat-label">Total Earnings</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${stats.highest_win.toFixed(2)}</div>
                        <div class="stat-label">Highest Win</div>
                    </div>
                `;
            }
        }
        
        // Update achievements UI
        function updateAchievementsUI() {
            const achievementsList = document.getElementById('achievements-list');
            if (!achievementsList) return;
            
            if (userData.achievements.length === 0) {
                achievementsList.innerHTML = '<p>No achievements yet. Keep playing to earn achievements!</p>';
                return;
            }
            
            achievementsList.innerHTML = userData.achievements.map(achievement => `
                <div class="achievement-badge">
                    <i class="fas fa-trophy"></i> ${achievement.achievement_name}
                </div>
            `).join('');
        }
        
        // Update notifications UI
        function updateNotificationsUI() {
            const notificationPanel = document.getElementById('notification-panel');
            const notificationCount = document.getElementById('notification-count');
            
            if (notificationPanel) {
                if (userData.notifications.length === 0) {
                    notificationPanel.innerHTML = '<div class="notification-item">No notifications</div>';
                } else {
                    notificationPanel.innerHTML = userData.notifications.map(notification => `
                        <div class="notification-item ${notification.is_read ? '' : 'unread'}">
                            <strong>${notification.title}</strong><br>
                            ${notification.message}
                            <small>${formatDate(notification.created_at)}</small>
                        </div>
                    `).join('');
                }
            }
            
            if (notificationCount) {
                const unreadCount = userData.notifications.filter(n => !n.is_read).length;
                notificationCount.textContent = unreadCount;
                notificationCount.style.display = unreadCount > 0 ? 'flex' : 'none';
            }
        }
        
        // Render transaction history
        function renderTransactions() {
            if (!userData.loggedIn) return;
            
            transactionListEl.innerHTML = '';
            walletTransactionListEl.innerHTML = '';
            
            if (userData.transactions.length === 0) {
                const emptyEl = document.createElement('div');
                emptyEl.className = 'transaction-item';
                emptyEl.innerHTML = `
                    <div>No transactions yet</div>
                    <div class="transaction-amount positive">+KES 0.00</div>
                    <div>Start playing!</div>
                `;
                transactionListEl.appendChild(emptyEl);
                walletTransactionListEl.appendChild(emptyEl.cloneNode(true));
                return;
            }
            
            userData.transactions.forEach(transaction => {
                const transactionEl = document.createElement('div');
                transactionEl.className = 'transaction-item';
                
                const amountClass = transaction.type === 'loss' || transaction.type === 'withdrawal' ? 'negative' : 'positive';
                const sign = transaction.type === 'loss' || transaction.type === 'withdrawal' ? '-' : '+';
                
                transactionEl.innerHTML = `
                    <div>${transaction.description}</div>
                    <div class="transaction-amount ${amountClass}">${sign}KES ${parseFloat(transaction.amount).toFixed(2)}</div>
                    <div>${transaction.date}</div>
                `;
                
                transactionListEl.appendChild(transactionEl);
                walletTransactionListEl.appendChild(transactionEl.cloneNode(true));
            });
        }
        
        // Setup event listeners
        function setupEventListeners() {
            // Navigation tabs
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    if (!userData.loggedIn) {
                        showAuthModal();
                        return;
                    }
                    
                    document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    tab.classList.add('active');
                    document.getElementById(tab.dataset.tab).classList.add('active');
                });
            });
            
            // Play Now button
            document.getElementById('play-now-btn').addEventListener('click', () => {
                if (!userData.loggedIn) {
                    showAuthModal();
                    return;
                }
                
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                document.querySelector('.nav-tab[data-tab="play"]').classList.add('active');
                document.getElementById('play').classList.add('active');
            });
            
            // Bet options
            document.querySelectorAll('.bet-option').forEach(option => {
                option.addEventListener('click', () => {
                    document.querySelectorAll('.bet-option').forEach(o => o.classList.remove('active'));
                    option.classList.add('active');
                    
                    gameState.selectedTime = parseInt(option.dataset.time);
                    gameState.selectedMultiplier = parseFloat(option.dataset.multiplier);
                    gameState.timeLeft = gameState.selectedTime;
                    gameTimerEl.textContent = gameState.timeLeft;
                });
            });
            
            // Start game button
            document.getElementById('start-game').addEventListener('click', startGame);
            
            // Deposit and withdraw buttons
            document.getElementById('confirm-deposit').addEventListener('click', handleDeposit);
            document.getElementById('confirm-withdraw').addEventListener('click', handleWithdraw);
            
            // Profile and password buttons
            document.getElementById('save-profile').addEventListener('click', saveProfile);
            document.getElementById('change-password').addEventListener('click', changePassword);
            
            // Support button
            document.getElementById('send-support').addEventListener('click', sendSupport);
            
            // Auth toggle
            document.getElementById('auth-toggle').addEventListener('click', function() {
                if (userData.loggedIn) {
                    logout();
                } else {
                    showAuthModal();
                }
            });
            
            // Auth tabs
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    if (tab.dataset.auth === 'login') {
                        document.getElementById('login-form').style.display = 'block';
                        document.getElementById('signup-form').style.display = 'none';
                    } else {
                        document.getElementById('login-form').style.display = 'none';
                        document.getElementById('signup-form').style.display = 'block';
                    }
                });
            });
            
            // Auth buttons
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('signup-btn').addEventListener('click', handleSignup);
            
            // Close auth modal when clicking outside
            authModalEl.addEventListener('click', function(e) {
                if (e.target === authModalEl) {
                    hideAuthModal();
                }
            });
            
            // Notification bell
            notificationBellEl.addEventListener('click', function() {
                notificationPanelEl.classList.toggle('active');
            });
            
            // Close notification panel when clicking outside
            document.addEventListener('click', function(e) {
                if (!notificationBellEl.contains(e.target)) {
                    notificationPanelEl.classList.remove('active');
                }
            });
            
            // Expandable sections
            document.querySelectorAll('.section-header').forEach(header => {
                header.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    content.classList.toggle('active');
                    
                    const icon = this.querySelector('i');
                    if (content.classList.contains('active')) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    } else {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                });
            });
            
            // FAQ items
            document.querySelectorAll('.faq-question').forEach(question => {
                question.addEventListener('click', function() {
                    const answer = this.nextElementSibling;
                    answer.classList.toggle('active');
                    
                    const icon = this.querySelector('i');
                    if (answer.classList.contains('active')) {
                        icon.classList.remove('fa-chevron-down');
                        icon.classList.add('fa-chevron-up');
                    } else {
                        icon.classList.remove('fa-chevron-up');
                        icon.classList.add('fa-chevron-down');
                    }
                });
            });
            
            // Copy referral code buttons
            document.getElementById('copy-referral').addEventListener('click', () => copyReferralCode());
            document.getElementById('copy-account-referral').addEventListener('click', () => copyReferralCode());
        }
        
        // Copy referral code to clipboard
        function copyReferralCode() {
            if (!userData.loggedIn) return;
            
            navigator.clipboard.writeText(userData.referralCode)
                .then(() => {
                    showMessage("Referral code copied to clipboard!", "success");
                })
                .catch(err => {
                    console.error('Failed to copy: ', err);
                    showMessage("Failed to copy referral code", "error");
                });
        }
        
        // Show auth modal
        function showAuthModal() {
            authModalEl.classList.add('active');
        }
        
        // Hide auth modal
        function hideAuthModal() {
            authModalEl.classList.remove('active');
        }
        
        // Handle login
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showMessage("Please fill in all fields", "error", authModalEl);
                return;
            }
            
            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });
                
                if (error) throw error;
                
                if (data.user) {
                    await fetchUserData(data.user.id);
                    updateUIForLoggedInUser();
                    hideAuthModal();
                    showMessage("Login successful!", "success");
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage(error.message, "error", authModalEl);
            }
        }
        
        // Handle signup
        async function handleSignup() {
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const phone = document.getElementById('signup-phone').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('signup-confirm-password').value;
            const referralCode = document.getElementById('signup-referral-code').value;
            
            if (!name || !email || !phone || !password || !confirmPassword) {
                showMessage("Please fill in all fields", "error", authModalEl);
                return;
            }
            
            if (password !== confirmPassword) {
                showMessage("Passwords do not match", "error", authModalEl);
                return;
            }
            
            try {
                // Create user in Supabase Auth
                const { data, error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: name,
                            phone: phone
                        }
                    }
                });
                
                if (error) throw error;
                
                if (data.user) {
                    // Create user profile in database
                    const { error: profileError } = await supabase
                        .from('profiles')
                        .insert([
                            {
                                id: data.user.id,
                                full_name: name,
                                email: email,
                                phone: phone,
                                balance: 0,
                                referred_by: referralCode || null
                            }
                        ]);
                    
                    if (profileError) throw profileError;
                    
                    userData.loggedIn = true;
                    await fetchUserData(data.user.id);
                    updateUIForLoggedInUser();
                    hideAuthModal();
                    showMessage("Account created successfully! Please check your email for verification.", "success");
                }
            } catch (error) {
                console.error('Signup error:', error);
                showMessage(error.message, "error", authModalEl);
            }
        }
        
        // Logout
        async function logout() {
            const { error } = await supabase.auth.signOut();
            if (error) console.error('Logout error:', error);
            
            userData.loggedIn = false;
            userInfoEl.style.display = 'none';
            document.getElementById('auth-toggle').textContent = 'Login';
            showAuthModal();
        }
        
        // Start the game
        function startGame() {
            if (!userData.loggedIn) {
                showAuthModal();
                return;
            }
            
            if (gameState.gameActive) return;
            
            gameState.betAmount = parseFloat(betAmountEl.value);
            
            if (gameState.betAmount > userData.balance) {
                showMessage("Insufficient balance for this bet", "error");
                return;
            }
            
            if (gameState.betAmount < 10) {
                showMessage("Minimum bet is KES 10", "error");
                return;
            }
            
            // Deduct bet amount from balance
            userData.balance -= gameState.betAmount;
            updateBalance();
            
            // Add transaction
            addTransaction('loss', gameState.betAmount, 'Game Bet');
            
            // Initialize game state
            gameState.moves = 0;
            gameState.matches = 0;
            gameState.timeLeft = gameState.selectedTime;
            gameState.gameActive = true;
            gameState.lockBoard = false;
            gameState.flippedCards = [];
            
            movesEl.textContent = gameState.moves;
            matchesEl.textContent = gameState.matches;
            gameTimerEl.textContent = gameState.timeLeft;
            
            // Initialize game board
            initGameBoard();
            
            // Start timer
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                gameTimerEl.textContent = gameState.timeLeft;
                
                if (gameState.timeLeft <= 0) {
                    endGame(false);
                }
            }, 1000);
        }
        
        // Initialize game board
        function initGameBoard() {
            // Create pairs of symbols
            const gameCards = [...gameState.cardSymbols, ...gameState.cardSymbols];
            
            // Shuffle the cards
            const shuffledCards = [...gameCards].sort(() => Math.random() - 0.5);
            
            // Clear the game board
            gameBoardEl.innerHTML = '';
            
            // Create cards
            shuffledCards.forEach((symbol, index) => {
                const card = document.createElement('div');
                card.className = 'game-cell';
                card.dataset.symbol = symbol;
                card.dataset.index = index;
                card.textContent = '?';
                card.addEventListener('click', flipCard);
                gameBoardEl.appendChild(card);
            });
            
            // Update game state
            gameState.cards = Array.from(document.querySelectorAll('.game-cell'));
        }
        
        // Flip card function
        function flipCard() {
            if (!gameState.gameActive || gameState.lockBoard) return;
            if (this.classList.contains('flipped')) return;
            if (this.classList.contains('matched')) return;
            
            this.textContent = this.dataset.symbol;
            this.classList.add('flipped');
            
            gameState.flippedCards.push(this);
            
            if (gameState.flippedCards.length === 2) {
                gameState.moves++;
                movesEl.textContent = gameState.moves;
                checkForMatch();
            }
        }
        
        // Check for matching cards
        function checkForMatch() {
            gameState.lockBoard = true;
            
            const [card1, card2] = gameState.flippedCards;
            const isMatch = card1.dataset.symbol === card2.dataset.symbol;
            
            if (isMatch) {
                disableCards();
                gameState.matches++;
                matchesEl.textContent = gameState.matches;
                
                if (gameState.matches === gameState.cardSymbols.length) {
                    endGame(true);
                }
            } else {
                unflipCards();
            }
        }
        
        // Disable matched cards
        function disableCards() {
            gameState.flippedCards.forEach(card => {
                card.classList.add('matched');
                card.classList.remove('flipped');
            });
            
            resetBoard();
        }
        
        // Unflip non-matching cards
        function unflipCards() {
            setTimeout(() => {
                gameState.flippedCards.forEach(card => {
                    card.textContent = '?';
                    card.classList.remove('flipped');
                });
                
                resetBoard();
            }, 1000);
        }
        
        // Reset board after each turn
        function resetBoard() {
            gameState.lockBoard = false;
            gameState.flippedCards = [];
        }
        
        // End the game
        async function endGame(isWin) {
            clearInterval(gameState.timer);
            gameState.gameActive = false;
            
            const timeTaken = gameState.selectedTime - gameState.timeLeft;
            
            if (isWin) {
                const winnings = gameState.betAmount * gameState.selectedMultiplier;
                userData.balance += winnings;
                
                showMessage(`Congratulations! You won KES ${winnings.toFixed(2)}!`, "success");
                
                // Add transaction
                await addTransaction('win', winnings, 'Game Win');
                
                // Update balance in database
                await updateUserBalance();
            } else {
                showMessage(`Time's up! You lost your bet of KES ${gameState.betAmount.toFixed(2)}.`, "error");
                
                // Update balance in database
                await updateUserBalance();
            }
            
            // Record game session
            await recordGameSession(isWin, timeTaken);
            
            // Refresh game statistics
            await fetchGameStatistics(userData.id);
            
            updateBalance();
            renderTransactions();
            
            // Change card symbols for next game
            setTimeout(() => {
                changeCardSymbols();
            }, 3000);
        }
        
        // Record game session
        async function recordGameSession(isWin, timeTaken) {
            try {
                const { error } = await supabase
                    .from('game_sessions')
                    .insert([
                        {
                            user_id: userData.id,
                            bet_amount: gameState.betAmount,
                            time_challenge: gameState.selectedTime,
                            multiplier: gameState.selectedMultiplier,
                            moves: gameState.moves,
                            time_taken: timeTaken,
                            won: isWin,
                            earnings: isWin ? gameState.betAmount * gameState.selectedMultiplier : 0,
                            card_symbols_used: gameState.cardSymbols,
                            completed_at: new Date().toISOString()
                        }
                    ]);
                
                if (error) throw error;
                
                // Check for achievements
                await checkAchievements();
                
            } catch (error) {
                console.error('Error recording game session:', error);
            }
        }
        
        // Check and award achievements
        async function checkAchievements() {
            const stats = userData.gameStats;
            const newAchievements = [];
            
            // First Win
            if (stats.total_games_won >= 1 && !userData.achievements.find(a => a.achievement_type === 'first_win')) {
                newAchievements.push({
                    achievement_type: 'first_win',
                    achievement_name: 'First Victory',
                    description: 'Win your first game',
                    reward: 10
                });
            }
            
            // 10 Games Played
            if (stats.total_games_played >= 10 && !userData.achievements.find(a => a.achievement_type === '10_games')) {
                newAchievements.push({
                    achievement_type: '10_games',
                    achievement_name: 'Dedicated Player',
                    description: 'Play 10 games',
                    reward: 20
                });
            }
            
            // Big Win (KES 500+)
            if (stats.highest_win >= 500 && !userData.achievements.find(a => a.achievement_type === 'big_win')) {
                newAchievements.push({
                    achievement_type: 'big_win',
                    achievement_name: 'High Roller',
                    description: 'Win KES 500 or more in a single game',
                    reward: 50
                });
            }
            
            // Add new achievements to database
            for (const achievement of newAchievements) {
                try {
                    const { error } = await supabase
                        .from('user_achievements')
                        .insert([
                            {
                                user_id: userData.id,
                                ...achievement
                            }
                        ]);
                    
                    if (!error) {
                        // Award bonus
                        userData.balance += achievement.reward;
                        await updateUserBalance();
                        
                        // Add transaction
                        await addTransaction('bonus', achievement.reward, `Achievement: ${achievement.achievement_name}`);
                        
                        // Show notification
                        showMessage(`Achievement unlocked: ${achievement.achievement_name}! +KES ${achievement.reward}`, "success");
                    }
                } catch (error) {
                    console.error('Error awarding achievement:', error);
                }
            }
            
            // Refresh achievements
            if (newAchievements.length > 0) {
                await fetchUserAchievements(userData.id);
            }
        }
        
        // Change card symbols
        function changeCardSymbols() {
            const newSymbols = ['ðŸš€', 'â­', 'ðŸŽ¯', 'ðŸŽ¨', 'ðŸŽ­', 'ðŸŽª', 'ðŸŽ®', 'ðŸŽ²'];
            gameState.cardSymbols = newSymbols;
        }
        
        // Handle deposit
        async function handleDeposit() {
            if (!userData.loggedIn) {
                showAuthModal();
                return;
            }
            
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            
            if (amount < 100) {
                showMessage("Minimum deposit is KES 100", "error");
                return;
            }
            
            userData.balance += amount;
            updateBalance();
            
            // Add transaction
            await addTransaction('deposit', amount, 'Deposit');
            
            // Update balance in database
            await updateUserBalance();
            
            showMessage(`Successfully deposited KES ${amount.toFixed(2)}`, "success");
        }
        
        // Handle withdraw
        async function handleWithdraw() {
            if (!userData.loggedIn) {
                showAuthModal();
                return;
            }
            
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            
            if (amount > userData.balance) {
                showMessage("Insufficient balance", "error");
                return;
            }
            
            if (amount < 100) {
                showMessage("Minimum withdrawal is KES 100", "error");
                return;
            }
            
            userData.balance -= amount;
            updateBalance();
            
            // Add transaction
            await addTransaction('withdrawal', amount, 'Withdrawal');
            
            // Update balance in database
            await updateUserBalance();
            
            // If user was referred by someone, give 5% commission to referrer
            if (userData.referredBy) {
                await handleWithdrawalCommission(userData.referredBy, amount);
            }
            
            showMessage(`Successfully withdrew KES ${amount.toFixed(2)}`, "success");
        }
        
        // Handle withdrawal commission for referrer
        async function handleWithdrawalCommission(referralCode, amount) {
            try {
                // Find the user who referred this user
                const { data: referrer, error } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('referral_code', referralCode)
                    .single();
                
                if (error) throw error;
                
                if (referrer) {
                    const commission = amount * 0.05; // 5% commission
                    
                    // Update referrer's balance and earnings
                    const { error: updateError } = await supabase
                        .from('profiles')
                        .update({
                            referral_earnings: (referrer.referral_earnings || 0) + commission,
                            balance: (referrer.balance || 0) + commission
                        })
                        .eq('id', referrer.id);
                    
                    if (updateError) throw updateError;
                    
                    // Add transaction for referrer
                    const { error: transactionError } = await supabase
                        .from('transactions')
                        .insert([
                            {
                                user_id: referrer.id,
                                type: 'referral',
                                amount: commission,
                                description: `Commission from ${userData.name}'s withdrawal`
                            }
                        ]);
                    
                    if (transactionError) throw transactionError;
                }
            } catch (error) {
                console.error('Withdrawal commission error:', error);
            }
        }
        
        // Save profile
        async function saveProfile() {
            if (!userData.loggedIn) {
                showAuthModal();
                return;
            }
            
            const name = document.getElementById('user-name').value;
            const email = document.getElementById('user-email').value;
            const phone = document.getElementById('user-phone').value;
            
            if (!name || !email) {
                showMessage("Name and email are required", "error");
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({
                        full_name: name,
                        email: email,
                        phone: phone
                    })
                    .eq('id', userData.id);
                
                if (error) throw error;
                
                // Update local user data
                userData.name = name;
                userData.email = email;
                userData.phone = phone;
                userData.profilePic = name.split(' ').map(n => n[0]).join('').toUpperCase();
                profilePicEl.textContent = userData.profilePic;
                userNameEl.textContent = userData.name;
                
                showMessage("Profile updated successfully", "success");
            } catch (error) {
                console.error('Profile update error:', error);
                showMessage("Error updating profile: " + error.message, "error");
            }
        }
        
        // Change password
        async function changePassword() {
            if (!userData.loggedIn) {
                showAuthModal();
                return;
            }
            
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            if (!currentPassword || !newPassword || !confirmPassword) {
                showMessage("Please fill in all password fields", "error");
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showMessage("New passwords do not match", "error");
                return;
            }
            
            try {
                const { error } = await supabase.auth.updateUser({
                    password: newPassword
                });
                
                if (error) throw error;
                
                showMessage("Password changed successfully", "success");
                
                // Clear password fields
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            } catch (error) {
                console.error('Password change error:', error);
                showMessage(error.message, "error");
            }
        }
        
        // Send support message
        async function sendSupport() {
            if (!userData.loggedIn) {
                showAuthModal();
                return;
            }
            
            const subject = document.getElementById('support-subject').value;
            const message = document.getElementById('support-message').value;
            
            if (!subject || !message) {
                showMessage("Please fill in both subject and message", "error");
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('support_tickets')
                    .insert([
                        {
                            user_id: userData.id,
                            subject: subject,
                            message: message,
                            status: 'open'
                        }
                    ]);
                
                if (error) throw error;
                
                showMessage("Support message sent successfully", "success");
                
                // Clear form
                document.getElementById('support-subject').value = '';
                document.getElementById('support-message').value = '';
            } catch (error) {
                console.error('Support ticket error:', error);
                showMessage("Error sending support message", "error");
            }
        }
        
        // Add transaction to database
        async function addTransaction(type, amount, description) {
            try {
                const { error } = await supabase
                    .from('transactions')
                    .insert([
                        {
                            user_id: userData.id,
                            type: type,
                            amount: amount,
                            description: description
                        }
                    ]);
                
                if (error) throw error;
                
                // Update local transactions
                userData.transactions.unshift({
                    type: type,
                    amount: amount,
                    description: description,
                    date: 'Just now'
                });
                
                renderTransactions();
            } catch (error) {
                console.error('Transaction error:', error);
            }
        }
        
        // Update user balance in database
        async function updateUserBalance() {
            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ balance: userData.balance })
                    .eq('id', userData.id);
                
                if (error) throw error;
            } catch (error) {
                console.error('Balance update error:', error);
            }
        }
        
        // Show message
        function showMessage(text, type, parent = document.body) {
            // Remove existing messages
            const existingMessages = parent.querySelectorAll('.message');
            existingMessages.forEach(msg => msg.remove());
            
            // Create new message
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = text;
            
            // Insert message at the top of the active tab or parent
            if (parent === document.body) {
                const activeTab = document.querySelector('.tab-content.active');
                if (activeTab) {
                    activeTab.insertBefore(messageEl, activeTab.firstChild);
                } else {
                    parent.appendChild(messageEl);
                }
            } else {
                parent.appendChild(messageEl);
            }
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }
        
        // Initialize the app when the page loads
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
